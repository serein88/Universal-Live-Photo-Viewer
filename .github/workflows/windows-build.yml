name: Windows Build

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.41.1"
          channel: stable
          cache: true

      - name: Flutter Version
        run: flutter --version

      - name: Install Dependencies
        run: flutter pub get

      - name: Run Smoke and Widget Tests (if present, non-blocking)
        id: smoke_widget_tests
        continue-on-error: true
        shell: pwsh
        run: |
          $targets = @("test/smoke", "test/widget_test.dart") | Where-Object { Test-Path $_ }
          if ($targets.Count -eq 0) {
            Write-Host "No smoke/widget tests found in repository. Skipping."
            exit 0
          }
          flutter test @targets -r compact

      - name: Run Core Tests (if present, non-blocking)
        id: core_tests
        continue-on-error: true
        shell: pwsh
        run: |
          $targets = @(
            "test/domain",
            "test/application",
            "test/data/parsers",
            "test/integration"
          ) | Where-Object { Test-Path $_ }
          if ($targets.Count -eq 0) {
            Write-Host "No core test targets found in repository. Skipping."
            exit 0
          }
          flutter test @targets -r compact

      - name: Summarize Test Results
        if: always()
        shell: pwsh
        run: |
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## Test Result (Non-blocking)"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- smoke/widget outcome: ${{ steps.smoke_widget_tests.outcome }}"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- smoke/widget conclusion: ${{ steps.smoke_widget_tests.conclusion }}"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- core tests outcome: ${{ steps.core_tests.outcome }}"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- core tests conclusion: ${{ steps.core_tests.conclusion }}"

      - name: Build Windows Release
        run: flutter build windows --release

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ulpv-windows-release-${{ github.sha }}
          path: build/windows/x64/runner/Release
          if-no-files-found: error
          retention-days: 7
